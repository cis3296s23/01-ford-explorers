<!doctype html>
<html>

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Explorify</title>
  <link rel="stylesheet" href="//netdna.bootstrapcdn.com/bootstrap/3.1.1/css/bootstrap.min.css">
  <link rel="stylesheet" href="main.css">
  <link rel="icon" href="favicon.png" type="image/x-icon">

  <style type="text/css">
    #login,
    #loggedin {
      display: none;
    }

    .text-overflow {
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      width: 500px;
    }
  </style>
</head>

<body>
  <div class="container">
    <div id="login">
      <h1>Connect to Spotify to begin a new journey!</h1>
      <a href="/login" class="btn btn-primary">Log in with Spotify</a>
    </div>
    <div id="loggedin">
      <div class="left">
        <div id="user-profile">
        </div>
        <div id="playList" class="playlist-container"></div>
      </div>
      <div class="right">
        <div id="trackPlayer">
          <div id="suggestions">
            <h2>Suggested Tracks</h2>
          </div>
          <div id="artists">
            <h2>Recent Artists</h2>
          </div>
        </div>
        <div>
          <div id="playlist-form">
            <h2>Create or update playlist:</h2>
            <input type="text" id="playlist-name" placeholder="Enter playlist name"
              style="color: black; font-size: 16px;">
            <button id="createPlaylist" class="btn btn-primary">Create or Update Playlist</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script id="user-profile-template" type="text/x-handlebars-template">
    <a href="{{external_urls.spotify}}">
      <h1>Logged in as {{display_name}}</h1>
    </a>
          <img class="media-object" style='width: 20rem; height: auto; margin:auto;' src="{{images.0.url}}" />
        
    </script>








  <script src="//cdnjs.cloudflare.com/ajax/libs/handlebars.js/2.0.0-alpha.1/handlebars.min.js"></script>
  <script src="http://code.jquery.com/jquery-1.10.1.min.js"></script>
  <script>
    (function () {

      /**
       * Obtains parameters from the hash of the URL
       * @return Object
       */
      function getHashParams() {
        var hashParams = {};
        var e, r = /([^&;=]+)=?([^&;]*)/g,
          q = window.location.hash.substring(1);
        while (e = r.exec(q)) {
          hashParams[e[1]] = decodeURIComponent(e[2]);
        }
        return hashParams;
      }

      var userProfileSource = document.getElementById('user-profile-template').innerHTML,
        userProfileTemplate = Handlebars.compile(userProfileSource),
        userProfilePlaceholder = document.getElementById('user-profile');

      var params = getHashParams();

      var access_token = params.access_token,
        refresh_token = params.refresh_token,
        error = params.error;

      var playlistMap = new Map();
      var userId;

      var artistsList = [];

      if (error) {
        alert('There was an error during the authentication');
      } else {
        if (access_token) {
          // render oauth info

          // fetch user information
          $.ajax({
            url: 'https://api.spotify.com/v1/me',
            headers: {
              'Authorization': 'Bearer ' + access_token
            },
            success: function (response) {
              userId = response.id;
              userProfilePlaceholder.innerHTML = userProfileTemplate(response);

              function getUserPlaylists() {
                $.ajax({
                  url: 'https://api.spotify.com/v1/me/playlists',
                  headers: {
                    'Authorization': 'Bearer ' + access_token
                  },
                  success: function (response) {
                    displayUserPlaylists(response);
                  },
                  error: function (error) {
                    console.log('Error retrieving playlists:', error);
                  }
                });
              }

              function getPlaylistSongs(playlistId, callback) {
                $.ajax({
                  url: `https://api.spotify.com/v1/playlists/${playlistId}/tracks`,
                  headers: {
                    'Authorization': 'Bearer ' + access_token
                  },
                  success: function (response) {
                    callback(response.items);
                  },
                  error: function (error) {
                    console.log('Error retrieving songs for playlist:', error);
                  }
                });
              }

              function displayUserPlaylists(response) {
                var playlists = response.items;
                var playlistContainer = $('#playList');
                playlistContainer.empty();

                playlists.forEach(function (playlist) {
                  var playlistDropdown = $('<details class="playlist-dropdown"></details>');
                  var playlistSummary = $('<summary></summary>').text(playlist.name);
                  playlistDropdown.append(playlistSummary);

                  getPlaylistSongs(playlist.id, function (songs) {
                    var songList = $('<ul class="song-list"></ul>');

                    songs.forEach(function (song) {
                      var songTitle = song.track.name;
                      var artistName = song.track.artists.map(artist => artist.name).join(', ');
                      var songItem = $('<li></li>').text(`${songTitle} - ${artistName}`);
                      songList.append(songItem);
                    });

                    playlistDropdown.append(songList);
                  });

                  playlistContainer.append(playlistDropdown);
                });
              }





              function addTracksToPlaylist(playlistId) {
                // Add your logic to add tracks to the playlist here
                var trackURI = 'spotify:track:2dHHgzDwk4BJdRwy9uXhTO';

                // AJAX call to add the hardcoded track to the playlist
                $.ajax({
                  method: 'POST',
                  url: 'https://api.spotify.com/v1/playlists/' + playlistId + '/tracks',
                  headers: {
                    'Authorization': 'Bearer ' + access_token,
                    'Content-Type': 'application/json'
                  },
                  data: JSON.stringify({
                    uris: [trackURI]
                  }),
                  success: function (response) {
                    console.log('Track added to the playlist successfully');
                  },
                  error: function (error) {
                    console.log('Error adding track to the playlist:', error);
                  }
                });
              }

              function createOrUpdatePlaylist(name) {
                // Retrieve the user's playlists
                $.ajax({
                  url: 'https://api.spotify.com/v1/me/playlists',
                  headers: {
                    'Authorization': 'Bearer ' + access_token
                  },
                  success: function (response) {
                    // Check if the specified playlist already exists
                    var existingPlaylist = response.items.find(function (playlist) {
                      return playlist.name === name;
                    });

                    // If the playlist exists, show a toast message
                    if (existingPlaylist) {
                      console.log('Playlist already exists with ID:', existingPlaylist.id);
                      showToast('You cannot create a new playlist with the same name.', 3000);
                    } else {
                      // If the playlist doesn't exist, create a new playlist and add tracks
                      $.ajax({
                        method: 'POST',
                        url: 'https://api.spotify.com/v1/users/' + userId + '/playlists',
                        headers: {
                          'Authorization': 'Bearer ' + access_token,
                          'Content-Type': 'application/json'
                        },
                        data: JSON.stringify({
                          'name': name,
                          'public': false,
                          'collaborative': false,
                          'description': 'A playlist of my favorite songs'
                        }),
                        success: function (response) {
                          console.log('New playlist created with ID:', response.id);
                          var playlistId = response.id;
                          addTracksToPlaylist(playlistId);
                          getUserPlaylists(); // Update the playlist in the div
                        },
                        error: function (error) {
                          console.log('Error creating playlist:', error);
                        }
                      });
                    }
                  },
                  error: function (error) {
                    console.log('Error retrieving playlists:', error);
                  }
                });
              }


              // Handle the createOrUpdatePlaylist button click
              $('#createPlaylist').on('click', function () {
                var playlistName = $('#playlist-name').val();

                if (playlistName) {
                  createOrUpdatePlaylist(playlistName);
                } else {
                  alert("Please enter a playlist name.");
                }
              });

              getUserPlaylists();
              $('#login').hide();
              $('#loggedin').show();
            }
          });


        } else {
          // render initial screen
          $('#login').show();
          $('#loggedin').hide();

        }

        function showToast(message, duration) {
          var toast = $('<div class="toast"></div>').text(message);
          $('body').append(toast);
          setTimeout(function () {
            toast.remove();
          }, duration || 3000);
        }



        function fetchRecentlyPlayed() {
          $.ajax({
            url: "https://api.spotify.com/v1/me/player/recently-played",
            headers: {
              "Authorization": "Bearer " + access_token
            },
            success: function (response) {
              console.log("Recently Played Tracks:");

              var artistsList = [];
              response.items.forEach(function (item) {
                var artistName = item.track.artists[0].name;
                if (!artistsList.includes(artistName)) {
                  artistsList.push(artistName);
                }
              });
              console.log(artistsList);

              localStorage.setItem("recentlyPlayedArtists", JSON.stringify(artistsList));
              var artists = document.getElementById("artists");
              var artistsContent = "<h2>Recently Played Artists:</h2><ul>";
              artistsList.forEach(function (artistName) {
                artistsContent += "<li>" + artistName + "</li>";
              });
              artistsContent += "</ul>";
              console.log(artistsContent);
              artists.innerHTML = artistsContent;
              return artistsContent;
            },
            error: function (xhr, status, error) {
              console.log("Error: " + error);
            }
          });
          console.log("refreshed");
        }

        fetchRecentlyPlayed(); // Call the function once to fetch the recently played tracks initially
        setInterval(fetchRecentlyPlayed, 15000); // Refresh the recent play list every 15 seconds


      }


      //Vestigile code from testing, may be useful later please do not delete.
      /*
            $.ajax({
              url: "https://api.spotify.com/v1/me/playlists",
              headers: {
                "Authorization": "Bearer " + access_token
              },
              success: function (response) {
                console.log("User Playlists:");
                var playlists = response.items.filter(function (item) {
                  return item.name;
                });
      
                var playlistMap = new Map();
      
                playlists.forEach(function (item) {
                  playlistMap.set(item.name, item.id);
                });
      
                console.log(playlistMap);
      
                var tracksContent = "<h2>Tracks:</h2>";
      
                playlistMap.forEach(function (playlistId, playlistName) {
                  $.ajax({
                    url: "https://api.spotify.com/v1/playlists/" + playlistId + "/tracks",
                    headers: {
                      "Authorization": "Bearer " + access_token
                    },
                    success: function (response) {
                      console.log("Tracks for playlist " + playlistName + ":");
                      tracksContent += "<h3>" + playlistName + "</h3><ul>";
                      response.items.forEach(function (item) {
                        console.log(item.track.name + " by " + item.track.artists[0].name);
                        tracksContent += "<li>" + item.track.name + " by " + item.track.artists[0].name + "</li>";
                      });
                      tracksContent += "</ul>";
                      track.innerHTML = tracksContent;
                    },
                    error: function (xhr, status, error) {
                      console.log("Error: " + error);
                    }
                  });
                });
              },
              error: function (xhr, status, error) {
                console.log("Error: " + error);
              }
            });
            */

      $.ajax({
        url: "https://api.spotify.com/v1/me/player/recently-played",
        headers: {
          "Authorization": "Bearer " + access_token
        },
        data: {
          limit: 50 // Get the 50 most recently played tracks
        },
        success: function (response) {
          // Choose a random track from the recently played list
          const track = response.items[Math.floor(Math.random() * response.items.length)].track;

          function showToast(message, duration) {
          var toast = $('<div class="toast"></div>').text(message);
          $('body').append(toast);
          setTimeout(function () {
            toast.remove();
          }, duration || 3000);
        }

        function getUserPlaylists1() {
                $.ajax({
                  url: 'https://api.spotify.com/v1/me/playlists',
                  headers: {
                    'Authorization': 'Bearer ' + access_token
                  },
                  success: function (response) {
                    displayUserPlaylists(response);
                  },
                  error: function (error) {
                    console.log('Error retrieving playlists:', error);
                  }
                });
              }

              function getPlaylistSongs(playlistId, callback) {
                $.ajax({
                  url: `https://api.spotify.com/v1/playlists/${playlistId}/tracks`,
                  headers: {
                    'Authorization': 'Bearer ' + access_token
                  },
                  success: function (response) {
                    callback(response.items);
                  },
                  error: function (error) {
                    console.log('Error retrieving songs for playlist:', error);
                  }
                });
              }

              function displayUserPlaylists(response) {
                var playlists = response.items;
                var playlistContainer = $('#playList');
                playlistContainer.empty();

                playlists.forEach(function (playlist) {
                  var playlistDropdown = $('<details class="playlist-dropdown"></details>');
                  var playlistSummary = $('<summary></summary>').text(playlist.name);
                  playlistDropdown.append(playlistSummary);

                  getPlaylistSongs(playlist.id, function (songs) {
                    var songList = $('<ul class="song-list"></ul>');

                    songs.forEach(function (song) {
                      var songTitle = song.track.name;
                      var artistName = song.track.artists.map(artist => artist.name).join(', ');
                      var songItem = $('<li></li>').text(`${songTitle} - ${artistName}`);
                      songList.append(songItem);
                    });

                    playlistDropdown.append(songList);
                  });

                  playlistContainer.append(playlistDropdown);
                });
              }


          function getUserPlaylists(callback) {
            $.ajax({
              url: 'https://api.spotify.com/v1/me/playlists',
              headers: {
                'Authorization': 'Bearer ' + access_token
              },
              success: function (response) {
                callback(response);
              },
              error: function (error) {
                console.log('Error retrieving playlists:', error);
              }
            });
          }

          function displayPlaylistOptions(trackId) {
            var playlistSelector = document.getElementById('playlistSelector');
            getUserPlaylists(function (response) {
              displayUserPlaylists(response, trackId);
            });

            function displayUserPlaylists(response, trackId) {
              var playlistsHtml = '<ul>';

              response.items.forEach(function (playlist) {
                playlistsHtml += `
  <li>
    <a href='#' onclick="addTrackToPlaylist('${playlist.id}', '${trackId}'); return false;">${playlist.name}</a>
  </li>`;
              });

              playlistsHtml += '</ul>';
              playlistSelector.innerHTML = playlistsHtml;
              playlistSelector.style.display = 'block';
            }
          }

          function addTrackToPlaylist(playlistId, trackId) {
            $.ajax({
              url: `https://api.spotify.com/v1/playlists/${playlistId}/tracks`,
              type: 'POST',
              headers: {
                'Authorization': 'Bearer ' + access_token,
                'Content-Type': 'application/json'
              },
              data: JSON.stringify({
                uris: [`spotify:track:${trackId}`]
              }),
              success: function (response) {
                showToast("You successfully added the song to playlist",4000);
                console.log('Track added to playlist.');
              },
              error: function (error) {
                showToast("Cannot add the song to playlist",4000);
                console.log('Error adding track to playlist:', error);
              }
            
            });
            getUserPlaylists1()
          }

          window.addTrackToPlaylist = addTrackToPlaylist;

          // Display the chosen track
          function show() {

            var songPlayed = false;

            // Use the chosen track as the seed for getting a track suggestion
            $.ajax({
              url: "https://api.spotify.com/v1/recommendations",
              headers: {
                "Authorization": "Bearer " + access_token
              },
              data: {
                limit: 20,
                seed_tracks: track.id // Use the ID of the chosen track as the seed
              },
              success: function (response) {
                console.log(response);
                let i = 0;
                var tracklist = response;
                var storeArtistList = JSON.parse(localStorage.getItem("recentlyPlayedArtists"));
                //var newList = JSON.parse(localStorage.getItem("suggestedList"));

                do {
                  //get reccomendation
                  var track = tracklist.tracks[i];

                  // check if the artist is in the recently played list
                  var artistName = track.artists[0].name;
                  var artistInRecentPlays = storeArtistList.includes(artistName);

                  if (artistInRecentPlays) {
                    console.log("Track: " + track.name + " not displayed " + artistName + " appears in listened list.");
                    i++;
                    //iterate if track appears
                  }

                  // only show if artist not in recently listened
                  else {
                    // build the preview
                    var trackName = track.name;
                    var albumName = track.album.name;
                    var previewUrl = track.preview_url;
                    var trackUrl = track.external_urls.spotify;
                    var imageUrl = track.album.images[0].url;
                    var previewHtml = `
                <h2>
                  Your Suggestion:
                </h2>
                <div>
                  <img src='${imageUrl}' style='width: 20rem; height: auto; margin: auto;'>
                </div>
                <div style="color:#121212; font-size:1.2rem;">
                  <a href='${trackUrl}'> ${trackName} by ${artistName}</a><br/>
                  From the album: ${albumName}<br/>
                  <audio id='previewAudio' src='${previewUrl}' controls></audio>
                </div>
                <button id="addToPlaylistBtn" style="margin-top: 1rem;">Add to Playlist</button>
                <div id="playlistSelector" style="display: none;"></div>
                `;
                    console.log(i);
                    // display the recommendation
                    suggestions.innerHTML = previewHtml;

                    var addToPlaylistBtn = document.getElementById('addToPlaylistBtn');
                    addToPlaylistBtn.addEventListener('click', function () {
                      displayPlaylistOptions(track.id);
                    });

                    //store the artist name in the recently played list
                    storeArtistList.push(artistName);
                    localStorage.setItem("recentlyPlayedArtists", JSON.stringify(storeArtistList));

                    // //stores the suggested track in a new list of the app's suggestions                    
                    // newList.push(track);
                    // localStorage.setItem("suggestedList", JSON.stringify(newList));
                    // console.log("new artist list: " + newList);


                    // Add event listener to the audio element
                    var audioElement = document.getElementById('previewAudio');
                    var pauseTimestamp = null;
                    audioElement.addEventListener('play', function () {
                      songPlayed = true;
                      if (pauseTimestamp) {
                        var currentTime = new Date().getTime();
                        if (currentTime - pauseTimestamp >= 15000) {
                          i++;
                          show();
                        }
                      }
                    });
                    audioElement.addEventListener('pause', function () {
                      pauseTimestamp = new Date().getTime();
                    });

                    setTimeout(function () {
                      if (!songPlayed) {
                        i++;
                        show();
                      }
                    }, 15000);

                    break;
                  }


                } while (artistInRecentPlays);
              },
              error: function (xhr, status, error) {
                console.log(`Error: ${error}`);
              }
            });
          }
          show();
        },
        error: function (xhr, status, error) {
          console.log(`Error: ${error}`);
        }
      });



    }
    )();

  </script>
</body>

</html>