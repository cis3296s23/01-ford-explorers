<!doctype html>
<html>

<head>
  <title>&#127760 Explorify</title>
  <title>&#127760 Explorify</title>
  <link rel="stylesheet" href="//netdna.bootstrapcdn.com/bootstrap/3.1.1/css/bootstrap.min.css">
  <link rel="stylesheet" href="main.css">
  <style type="text/css">
    #login,
    #loggedin {
      display: none;
    }

    .text-overflow {
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      width: 500px;
    }
  </style>
</head>

<body>
  <div class="container">
    <div id="login">
      <h1>Connect to Spotify to begin a new journey!</h1>
      <a href="/login" class="btn btn-primary">Log in with Spotify</a>
    </div>
    <div id="loggedin">
      <div class="left">
        <div id="user-profile">
        </div>
      </div>
      <div class="right">
        <div id="trackPlayer">
          <div id="suggestions">
            <h2>Suggested Tracks</h2>
          </div>
          <div id="artists">
            <h2>Recent Artists</h2>
          </div>
        </div>
        <div>
          <div id="playlist-form">
            <h2>Create or update playlist:</h2>
            <input type="text" id="playlist-name" placeholder="Enter playlist name"
              style="color: black; font-size: 16px;">
            <button id="createPlaylist" class="btn btn-primary">Create or Update Playlist</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script id="user-profile-template" type="text/x-handlebars-template">
    <a href="{{external_urls.spotify}}">
      <h1>Logged in as {{display_name}}</h1>
    </a>
          <img class="media-object" style='width: 20rem; height: auto; margin:auto;' src="{{images.0.url}}" />
        
    </script>








  <script src="//cdnjs.cloudflare.com/ajax/libs/handlebars.js/2.0.0-alpha.1/handlebars.min.js"></script>
  <script src="http://code.jquery.com/jquery-1.10.1.min.js"></script>
  <script>
    (function () {

      /**
       * Obtains parameters from the hash of the URL
       * @return Object
       */
      function getHashParams() {
        var hashParams = {};
        var e, r = /([^&;=]+)=?([^&;]*)/g,
          q = window.location.hash.substring(1);
        while (e = r.exec(q)) {
          hashParams[e[1]] = decodeURIComponent(e[2]);
        }
        return hashParams;
      }

      var userProfileSource = document.getElementById('user-profile-template').innerHTML,
        userProfileTemplate = Handlebars.compile(userProfileSource),
        userProfilePlaceholder = document.getElementById('user-profile');

      var params = getHashParams();

      var access_token = params.access_token,
        refresh_token = params.refresh_token,
        error = params.error;

      var playlistMap = new Map();
      var userId;

      var artistsList = [];

      if (error) {
        alert('There was an error during the authentication');
      } else {
        if (access_token) {
          // render oauth info

          // fetch user information
          $.ajax({
            url: 'https://api.spotify.com/v1/me',
            headers: {
              'Authorization': 'Bearer ' + access_token
            },
            success: function (response) {
              userId = response.id;
              userProfilePlaceholder.innerHTML = userProfileTemplate(response);

              function addTracksToPlaylist(playlistId) {
                // Add your logic to add tracks to the playlist here
                var trackURI = 'spotify:track:2dHHgzDwk4BJdRwy9uXhTO';

                // AJAX call to add the hardcoded track to the playlist
                $.ajax({
                  method: 'POST',
                  url: 'https://api.spotify.com/v1/playlists/' + playlistId + '/tracks',
                  headers: {
                    'Authorization': 'Bearer ' + access_token,
                    'Content-Type': 'application/json'
                  },
                  data: JSON.stringify({
                    uris: [trackURI]
                  }),
                  success: function (response) {
                    console.log('Track added to the playlist successfully');
                  },
                  error: function (error) {
                    console.log('Error adding track to the playlist:', error);
                  }
                });
              }

              function createOrUpdatePlaylist(name) {
                // Retrieve the user's playlists
                $.ajax({
                  url: 'https://api.spotify.com/v1/me/playlists',
                  headers: {
                    'Authorization': 'Bearer ' + access_token
                  },
                  success: function (response) {
                    // Check if the specified playlist already exists
                    var existingPlaylist = response.items.find(function (playlist) {
                      return playlist.name === name;
                    });

                    // If the playlist exists, add tracks to it
                    if (existingPlaylist) {
                      console.log('Playlist already exists with ID:', existingPlaylist.id);
                      addTracksToPlaylist(existingPlaylist.id);
                    } else {
                      // If the playlist doesn't exist, create a new playlist and add tracks
                      $.ajax({
                        method: 'POST',
                        url: 'https://api.spotify.com/v1/users/' + userId + '/playlists',
                        headers: {
                          'Authorization': 'Bearer ' + access_token,
                          'Content-Type': 'application/json'
                        },
                        data: JSON.stringify({
                          'name': name,
                          'public': false,
                          'collaborative': false,
                          'description': 'A playlist of my favorite songs'
                        }),
                        success: function (response) {
                          console.log('New playlist created with ID:', response.id);
                          var playlistId = response.id;
                          addTracksToPlaylist(playlistId);
                        },
                        error: function (error) {
                          console.log('Error creating playlist:', error);
                        }
                      });
                    }
                  },
                  error: function (error) {
                    console.log('Error retrieving playlists:', error);
                  }
                });
              }

              // Handle the createOrUpdatePlaylist button click
              $('#createPlaylist').on('click', function () {
                var playlistName = $('#playlist-name').val();

                if (playlistName) {
                  createOrUpdatePlaylist(playlistName);
                } else {
                  alert("Please enter a playlist name.");
                }
              });


              $('#login').hide();
              $('#loggedin').show();
            }
          });


        } else {
          // render initial screen
          $('#login').show();
          $('#loggedin').hide();

        }



        $.ajax({
          url: "https://api.spotify.com/v1/me/player/recently-played",
          headers: {
            "Authorization": "Bearer " + access_token
          },
          success: function (response) {
            console.log("Recently Played Tracks:");
            var tracksAndArtistsList = [];

            response.items.forEach(function (item) {
              var trackName = item.track.name;
              var artistName = item.track.artists[0].name;
              var trackAndArtist = trackName + " by " + artistName;

              if (!tracksAndArtistsList.includes(trackAndArtist)) {
                tracksAndArtistsList.push(trackAndArtist);
              }

              if (!artistsList.includes(artistName)) {
                artistsList.push(artistName);
              }
            });

            console.log(tracksAndArtistsList);

            localStorage.setItem("recentlyPlayedArtists", JSON.stringify(artistsList));

            var tracksAndArtists = document.getElementById("artists");
            var content = "<h2>Recently Played Tracks and Artists:</h2>";

            tracksAndArtistsList.forEach(function (trackAndArtist) {
              content += "<li>" + trackAndArtist + "</li>";
            });

            content += "</ul>";
            console.log(content);
            tracksAndArtists.innerHTML = content;
            return content;
          },
          error: function (xhr, status, error) {
            console.log("Error: " + error);
          }
        });

      }


      //Vestigile code from testing, may be useful later please do not delete.
      /*
            $.ajax({
              url: "https://api.spotify.com/v1/me/playlists",
              headers: {
                "Authorization": "Bearer " + access_token
              },
              success: function (response) {
                console.log("User Playlists:");
                var playlists = response.items.filter(function (item) {
                  return item.name;
                });
      
                var playlistMap = new Map();
      
                playlists.forEach(function (item) {
                  playlistMap.set(item.name, item.id);
                });
      
                console.log(playlistMap);
      
                var tracksContent = "<h2>Tracks:</h2>";
      
                playlistMap.forEach(function (playlistId, playlistName) {
                  $.ajax({
                    url: "https://api.spotify.com/v1/playlists/" + playlistId + "/tracks",
                    headers: {
                      "Authorization": "Bearer " + access_token
                    },
                    success: function (response) {
                      console.log("Tracks for playlist " + playlistName + ":");
                      tracksContent += "<h3>" + playlistName + "</h3><ul>";
                      response.items.forEach(function (item) {
                        console.log(item.track.name + " by " + item.track.artists[0].name);
                        tracksContent += "<li>" + item.track.name + " by " + item.track.artists[0].name + "</li>";
                      });
                      tracksContent += "</ul>";
                      track.innerHTML = tracksContent;
                    },
                    error: function (xhr, status, error) {
                      console.log("Error: " + error);
                    }
                  });
                });
              },
              error: function (xhr, status, error) {
                console.log("Error: " + error);
              }
            });
            */

      $.ajax({
        url: "https://api.spotify.com/v1/me/player/recently-played",
        headers: {
          "Authorization": "Bearer " + access_token
        },
        data: {
          limit: 50 // Get the 50 most recently played tracks
        },
        success: function (response) {
          // Choose a random track from the recently played list
          const track = response.items[Math.floor(Math.random() * response.items.length)].track;

          function show() {
            var songPlayed = false;

            $.ajax({
              url: "https://api.spotify.com/v1/recommendations",
              headers: {
                "Authorization": "Bearer " + access_token
              },
              data: {
                limit: 20,
                seed_tracks: track.id // Use the ID of the chosen track as the seed
              },
              success: function (response) {
                console.log(response);
                let i = 0;
                var tracklist = response;

                var storeArtistList = JSON.parse(localStorage.getItem("recentlyPlayedArtist"));

                do {
                  // Get recommendation
                  var track = tracklist.tracks[i];

                  // Check if the artist is in the recently played list
                  var artistName = track.artists[0].name;
                  var artistInRecentPlays = storeArtistList.includes(artistName);

                  if (artistInRecentPlays) {
                    console.log("Track: " + track.name + " not displayed " + artistName + " appears in listened list.");
                    i++;
                    // Iterate if track appears
                  } else {
                    // Build the preview
                    var trackName = track.name;
                    var albumName = track.album.name;
                    var previewUrl = track.preview_url;
                    var trackUrl = track.external_urls.spotify;
                    var imageUrl = track.album.images[0].url;
                    var previewHtml = "<h2>Your Suggestion:</h2><img src='" + imageUrl + "' style='max-width: 150px; max-height: 150px;'><p><a href='" + trackUrl + "'>" + trackName + " by " + artistName + "</a></p><p>From the album: " + albumName + "</p><audio id='previewAudio' src='" + previewUrl + "' controls></audio>";
                    console.log(i);

                    suggestions.innerHTML = previewHtml;

                    // Add event listener to the audio element
                    var audioElement = document.getElementById('previewAudio');
                    var pauseTimestamp = null;
                    audioElement.addEventListener('play', function () {
                      songPlayed = true;
                      if (pauseTimestamp) {
                        var currentTime = new Date().getTime();
                        if (currentTime - pauseTimestamp >= 5000) {
                          i++;
                          show();
                        }
                      }
                    });
                    audioElement.addEventListener('pause', function () {
                      pauseTimestamp = new Date().getTime();
                    });

                    setTimeout(function () {
                      if (!songPlayed) {
                        i++;
                        show();
                      }
                    }, 5000);

                    break;
                  }
                  } while  (artistInRecentPlays);
              },
              error: function (xhr, status, error) {
                console.log(`Error: ${error}`);
              }
            });
          }

          show();
        },
        error: function (xhr, status, error) {
          console.log(`Error: ${error}`);
        }
      });




    }
    )();

  </script>
</body>

</html>