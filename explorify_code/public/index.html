<!doctype html>
<html>

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Explorify</title>
  <link rel="stylesheet" href="//netdna.bootstrapcdn.com/bootstrap/3.1.1/css/bootstrap.min.css">
  <link rel="stylesheet" href="main.css">
  <link rel="icon" href="favicon.png" type="image/x-icon">

  <style type="text/css">
    #login,
    #loggedin {
      display: none;
    }

    .text-overflow {
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      width: 500px;
    }
  </style>
</head>

<body>
  <div class="container">
    <div id="login">
      <h1>Connect to Spotify to begin a new journey!</h1>
      <a href="/login" class="btn btn-primary">Log in with Spotify</a>
    </div>
    <div id="loggedin">
      <div class="left">
        <div id="user-profile">
        </div>
        <div id="playList" class="playlist-container"></div>
      </div>
      <div class="right">
        <div id="trackPlayer">
          <div id="suggestions">
            <h2>Suggested Tracks</h2>
          </div>
          <div id="playlistSelector" style="display: none;">
          </div>
          <div id="artists">
            <h2>Recent Artists</h2>
          </div>
        </div>
        <div>
          <div id="playlist-form">
            <h2>Create Playlist:</h2>
            <input type="text" id="playlist-name" placeholder="Enter playlist name"
              style="color: black; font-size: 16px;">
            <button id="createPlaylist" class="btn btn-primary">Create Playlist</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script id="user-profile-template" type="text/x-handlebars-template">
    <a href="{{external_urls.spotify}}">
      <h1>Logged in as {{display_name}}</h1>
    </a>
          <img class="media-object" style='width: 20rem; height: auto; margin:auto;' src="{{images.0.url}}" />
        
    </script>








  <script src="//cdnjs.cloudflare.com/ajax/libs/handlebars.js/2.0.0-alpha.1/handlebars.min.js"></script>
  <script src="http://code.jquery.com/jquery-1.10.1.min.js"></script>
  <script>
    let access_token;
    let userId;
    (function () {
      var userProfileSource = document.getElementById('user-profile-template').innerHTML,
        userProfileTemplate = Handlebars.compile(userProfileSource),
        userProfilePlaceholder = document.getElementById('user-profile');

      var params = getHashParams();

      access_token = params.access_token,
        refresh_token = params.refresh_token,
        error = params.error;

      var playlistMap = new Map();


      var artistsList = [];

      if (error) {
        alert('There was an error during the authentication');
      } else {
        if (access_token) {
          // render oauth info

          // fetch user information
          $.ajax({
            url: 'https://api.spotify.com/v1/me',
            headers: {
              'Authorization': 'Bearer ' + access_token
            },
            success: function (response) {
              userId = response.id;
              userProfilePlaceholder.innerHTML = userProfileTemplate(response);



              getUserPlaylists();
              $('#login').hide();
              $('#loggedin').show();
            }
          });


        } else {
          // render initial screen
          $('#login').show();
          $('#loggedin').hide();

        }




        $.ajax({
          url: "https://api.spotify.com/v1/me/player/recently-played",
          headers: {
            "Authorization": "Bearer " + access_token
          },
          data: {
            limit: 50 // Get the 50 most recently played tracks
          },
          success: function (response) {
            // Choose a random track from the recently played list
            const track = response.items[Math.floor(Math.random() * response.items.length)].track;
            window.addTrackToPlaylist = addTrackToPlaylist;

            // Display the chosen track

            show(track.id);
          },
          error: function (xhr, status, error) {
            console.log(`Error: ${error}`);
          }
        });


      }
    })();


    function showToast(message, duration) {
      var toast = $('<div class="toast"></div>').text(message);
      $('body').append(toast);
      setTimeout(function () {
        toast.remove();
      }, duration || 3000);
    }



    function fetchRecentlyPlayed() {
      $.ajax({
        url: "https://api.spotify.com/v1/me/player/recently-played",
        headers: {
          "Authorization": "Bearer " + access_token
        },
        success: function (response) {
          console.log("Recently Played Tracks:");

          var artistsList = [];
          response.items.forEach(function (item) {
            var artistName = item.track.artists[0].name;
            if (!artistsList.includes(artistName)) {
              artistsList.unshift(artistName);
            }
          });
          console.log(artistsList);
          if (localStorage.getItem("recentlyPlayedArtists") == null) {
            localStorage.setItem("recentlyPlayedArtists", JSON.stringify(artistsList));
          }

          var storeArtistList = JSON.parse(localStorage.getItem("recentlyPlayedArtists"));
          var artists = document.getElementById("artists");
          var artistsContent = "<h2>Recently Played Artists:</h2><ul>";
          var firstTenArtists = storeArtistList.slice(0, 5);
          firstTenArtists.forEach(function (artistName) {
            artistsContent += "<li>" + artistName + "</li>";
          });
          artistsContent += "</ul>";
          console.log(artistsContent);
          artists.innerHTML = artistsContent;
        },
        error: function (xhr, status, error) {
          console.log("Error: " + error);
        }
      });
      console.log("refreshed");
    }

    fetchRecentlyPlayed(); // Call the function once to fetch the recently played tracks initially
    setInterval(fetchRecentlyPlayed, 15000); // Refresh the recent play list every 15 seconds




    function getPlaylistSongs(playlistId, callback) {
      $.ajax({
        url: `https://api.spotify.com/v1/playlists/${playlistId}/tracks`,
        headers: {
          'Authorization': 'Bearer ' + access_token
        },
        success: function (response) {
          callback(response.items);
        },
        error: function (error) {
          console.log('Error retrieving songs for playlist:', error);
        }
      });
    }

    // Consolidated function for getting user playlists
    function getUserPlaylists(callback) {
      $.ajax({
        url: 'https://api.spotify.com/v1/me/playlists',
        headers: {
          'Authorization': 'Bearer ' + access_token
        },
        success: function (response) {
          if (callback) {
            callback(response);
          }
        },
        error: function (error) {
          console.log('Error retrieving playlists:', error);
        }
      });
    }

    // Updated displayUserPlaylists function
    function displayUserPlaylists(response, trackId) {
      var playlists = response.items;
      var playlistContainer = $('#playList');
      var playlistSelector = $('#playlistSelector');
      playlistContainer.empty();
      playlistSelector.empty();

      playlists.forEach(function (playlist) {
        var playlistDropdown = $('<details class="playlist-dropdown"></details>');
        var playlistSummary = $('<summary></summary>').text(playlist.name);


        playlistDropdown.append(playlistSummary);

        getPlaylistSongs(playlist.id, function (songs) {
          var songList = $('<ul class="song-list"></ul>');

          songs.forEach(function (song) {
            var songTitle = song.track.name;
            var artistName = song.track.artists.map(artist => artist.name).join(', ');
            var songSpotifyUrl = song.track.external_urls.spotify;
            var songItem = $('<li></li>').addClass('song-item');;
            var songLink = $('<a></a>').addClass('spotify-song-link').text(`${songTitle} - ${artistName}`).attr('href', songSpotifyUrl).attr('target', '_blank');
            var deleteSongButton = $('<button class="delete-song spotify-button">Delete</button>');
            deleteSongButton.on('click', function (event) {
              event.preventDefault(); // Prevent the click event from propagating to the parent anchor element
              deleteSongFromPlaylist(playlist.id, song.track.id);
            });
            songItem.append(songLink);
            songItem.append(deleteSongButton);
            songList.append(songItem);
          });

          playlistDropdown.append(songList);
        });

        playlistContainer.append(playlistDropdown);

        // Display the clickable playlist list for adding the track
        if (trackId) {
          var playlistOption = $('<li></li>').text(playlist.name);
          playlistOption.on('click', function () {
            addTrackToPlaylist(playlist.id, trackId, function () {
              fetchRecentlyPlayed(); // Add the fetchRecentlyPlayed() call here
            });
            playlistSelector.hide();
            displayPlaylistOptions(trackId)
          });
          playlistSelector.append(playlistOption);
        }
      });
    }



    function deleteSongFromPlaylist(playlistId, trackId) {
      $.ajax({
        url: `https://api.spotify.com/v1/playlists/${playlistId}/tracks`,
        type: 'DELETE',
        headers: {
          'Authorization': 'Bearer ' + access_token,
          'Content-Type': 'application/json'
        },
        data: JSON.stringify({
          tracks: [{
            uri: `spotify:track:${trackId}`
          }]
        }),
        success: function () {
          // Refresh the playlist display
          getUserPlaylists(displayUserPlaylists);
        },
        error: function (error) {
          console.error("Error deleting song from playlist: ", error);
        }
      });
    }



    // Updated displayPlaylistOptions function
    function displayPlaylistOptions(trackId) {
      var playlistSelector = document.getElementById('playlistSelector');
      getUserPlaylists(function (response) {
        displayUserPlaylists(response, trackId);
      });
    }


    function createOrUpdatePlaylist(name) {
      // Retrieve the user's playlists
      $.ajax({
        url: 'https://api.spotify.com/v1/me/playlists',
        headers: {
          'Authorization': 'Bearer ' + access_token
        },
        success: function (response) {
          // Check if the specified playlist already exists
          var existingPlaylist = response.items.find(function (playlist) {
            return playlist.name === name;
          });

          // If the playlist exists, show a toast message
          if (existingPlaylist) {
            console.log('Playlist already exists with ID:', existingPlaylist.id);
            showToast('You cannot create a new playlist with the same name.', 3000);
          } else {
            // If the playlist doesn't exist, create a new playlist and add tracks
            $.ajax({
              method: 'POST',
              url: 'https://api.spotify.com/v1/users/' + userId + '/playlists',
              headers: {
                'Authorization': 'Bearer ' + access_token,
                'Content-Type': 'application/json'
              },
              data: JSON.stringify({
                'name': name,
                'public': false,
                'collaborative': false,
                'description': 'A playlist of my favorite songs'
              }),
              success: function (response) {
                console.log('New playlist created with ID:', response.id);
                getUserPlaylists(); // Update the playlist in the div
                showToast("You have successfully created a new playlist " + name, 3000);
                show();
              },
              error: function (error) {
                console.log('Error creating playlist:', error);
              }
            });
          }
        },
        error: function (error) {
          console.log('Error retrieving playlists:', error);
        }
      });
    }


    // Handle the createOrUpdatePlaylist button click
    $('#createPlaylist').on('click', function () {
      var playlistName = $('#playlist-name').val();

      if (playlistName) {
        createOrUpdatePlaylist(playlistName);
        resetPlaylistNameInput();
      } else {
        showToast("Please enter a playlist name", 3000);
      }
    });

    function resetPlaylistNameInput() {
      const playlistNameInput = document.getElementById('playlist-name');
      playlistNameInput.value = '';
    }

    /**
     * Obtains parameters from the hash of the URL
     * @return Object
     */
    function getHashParams() {
      var hashParams = {};
      var e, r = /([^&;=]+)=?([^&;]*)/g,
        q = window.location.hash.substring(1);
      while (e = r.exec(q)) {
        hashParams[e[1]] = decodeURIComponent(e[2]);
      }
      return hashParams;
    }


    function getPlaylistSongs(playlistId, callback) {
      $.ajax({
        url: `https://api.spotify.com/v1/playlists/${playlistId}/tracks`,
        headers: {
          'Authorization': 'Bearer ' + access_token
        },
        success: function (response) {
          callback(response.items);
        },
        error: function (error) {
          console.log('Error retrieving songs for playlist:', error);
        }
      });
    }






    function addTrackToPlaylist(playlistId, trackId, callback) {
      $.ajax({
        url: `https://api.spotify.com/v1/playlists/${playlistId}/tracks`,
        type: 'POST',
        headers: {
          'Authorization': 'Bearer ' + access_token,
          'Content-Type': 'application/json'
        },
        data: JSON.stringify({
          uris: [`spotify:track:${trackId}`]
        }),
        success: function (response) {
          showToast("You successfully added the song to playlist", 4000);
          console.log('Track added to playlist.');
          if (callback) {
            callback();
          }
        },
        error: function (error) {
          showToast("Cannot add the song to playlist", 4000);
          console.log('Error adding track to playlist:', error);
        }

      });
      getUserPlaylists();
    }

    //start 

    //Global variables
    var tracklist;
    var currentIndex = 0;

    function show(trackID) {
      // Check if the tracklist is not already fetched
      if (!tracklist || currentIndex >= tracklist.tracks.length) {
        getRecommendations(trackID, function (recommendations) {
          tracklist = recommendations;
          currentIndex = 0;
          displayTrack(trackID);
          displayPlaylistOptions(trackID);
        });
      } else {
        displayTrack(trackID);
        displayPlaylistOptions(trackID);
      }
    }

    function getRecommendations(trackID, callback) {
      $.ajax({
        url: "https://api.spotify.com/v1/recommendations",
        headers: {
          "Authorization": "Bearer " + access_token
        },
        data: {
          limit: 20,
          seed_tracks: trackID // Use the ID of the chosen track as the seed
        },
        success: function (response) {
          callback(response);
        },
        error: function (xhr, status, error) {
          console.log(`Error: ${error}`);
        }
      });
    }

    function displayTrack(trackID) {
      var songPlayed = false;
      var storeArtistList = JSON.parse(localStorage.getItem("recentlyPlayedArtists"));

      while (currentIndex < tracklist.tracks.length) {
        var track = tracklist.tracks[currentIndex];
        var artistName = track.artists[0].name;
        var artistInRecentPlays = storeArtistList.includes(artistName);

        if (artistInRecentPlays || !track.preview_url) {
          console.log("Track: " + track.name + " not displayed " + artistName + " appears in listened list. Or a sample for the song does not exist.");
          currentIndex++;
        } else {
          // Your existing code to build the preview and display it goes here
          // ...
          var trackName = track.name;
          var albumName = track.album.name;
          var previewUrl = track.preview_url;
          var trackUrl = track.external_urls.spotify;
          var imageUrl = track.album.images[0].url;
          var previewHtml = `
    <h2>
      Your Suggestion:
    </h2>
    <div>
      <img src='${imageUrl}' style='width: 20rem; height: auto; margin: auto;'>
    </div>
    <div style="color:#121212; font-size:1.2rem;">
      <a href='${trackUrl}'> ${trackName} by ${artistName}</a><br/>
      From the album: ${albumName}<br/>
      <audio id='previewAudio' src='${previewUrl}' controls></audio>
    </div>
    <button id="addToPlaylistBtn" style="margin-top: 1rem;">Add to Playlist</button>
    <button id="loadSuggestionsBtn">Load Suggestions</button>
    `;

          // display the recommendation
          suggestions.innerHTML = previewHtml;
          fetchRecentlyPlayed();

          var addToPlaylistBtn = document.getElementById('addToPlaylistBtn');

          addToPlaylistBtn.addEventListener('click', function () {
            displayPlaylistOptions(track.id);
          });

          var triggerElement = document.getElementById("addToPlaylistBtn");
          var playlistSelector = document.getElementById("playlistSelector");

          triggerElement.addEventListener("click", function (event) {
            event.preventDefault();
            if (playlistSelector.style.display === "block") {
              playlistSelector.style.display = "none";
            } else {
              playlistSelector.style.display = "block";
            }
          });





          // Store the artist name in the recently played list
          storeArtistList.unshift(artistName);
          localStorage.setItem("recentlyPlayedArtists", JSON.stringify(storeArtistList));


          var newSuggestion = document.getElementById('loadSuggestionsBtn');
          newSuggestion.addEventListener('click', function () {
            currentIndex++;
            show(trackID);
            if (playlistSelector.style.display === "block") {
              playlistSelector.style.display = "none";
            }
            // No need for an else block since we do nothing if it's not displayed
          });

          // Add event listener to the audio element
          var audioElement = document.getElementById('previewAudio');

          // Update event listener for 'ended' event
          audioElement.addEventListener('ended', function () {
            currentIndex++;
            show(trackID);
          });

          // audioElement.addEventListener('error', function () {
          //   console.log('Audio preview not available for this track. Skipping...');
          //   currentIndex++;
          //   show(trackID);
          // });

          audioElement.play();
          break;
        }
      }

      if (currentIndex >= tracklist.tracks.length) {
        // Get new recommendations if all tracks in the list have been checked
        getRecommendations(trackID, function (recommendations) {
          tracklist = recommendations;
          currentIndex = 0;
          displayTrack(trackID);
        });
      } else {
        fetchRecentlyPlayed();
      }
    }

//end



  </script>
</body>

</html>
